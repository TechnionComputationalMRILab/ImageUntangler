from vtkmodules.all import VTK_UNSIGNED_CHAR, VTK_UNSIGNED_SHORT, VTK_UNSIGNED_INT, VTK_UNSIGNED_LONG, \
    VTK_UNSIGNED_LONG_LONG, VTK_CHAR, VTK_SHORT, VTK_INT, VTK_LONG, VTK_SIZEOF_LONG,\
    VTK_LONG_LONG, VTK_FLOAT, VTK_DOUBLE
import numpy as np
from vtkmodules.all import vtkImageData
from vtkmodules.util import numpy_support

from MRICenterline.app.centerline.calculate import PointsToPlaneVectors
from MRICenterline import CFG


class CenterlineModel:
    def __init__(self, case_model):
        self.case_model = case_model
        self.widget = None
        self.point_array = None
        self.image_properties = None
        self.centerline_viewer = None
        self.parallel_scale = 0.1

        self.vtk_data = vtkImageData()

    def set_points_and_image(self, points, image):
        self.point_array = points
        self.image_properties = image

    def connect_viewer(self, centerline_viewer):
        self.centerline_viewer = centerline_viewer

    def connect_widget(self, widget):
        self.widget = widget

    def update_widget(self):
        self.widget.label.setText(f"Calculating MPR on {len(self.point_array)}")

        self.calculate_centerline()
        self.centerline_viewer.refresh_panel()

    def calculate_centerline(self):
        if CFG.get_testing_status("use-slice-location"):
            input_points = np.zeros(self.point_array.get_as_np_array().shape)
            z_coords = self.image_properties.z_coords

            for idx, pt in enumerate(self.point_array):
                transformed_coords = np.zeros(3, dtype=np.int32)
                transformed_coords[0] = pt.image_coordinates[0]
                transformed_coords[1] = pt.image_coordinates[1]
                transformed_coords[2] = z_coords[round(pt.slice_idx)]

                input_points[idx:] = transformed_coords
        else:
            input_points = self.point_array.get_as_np_array()

        # TODO manual input see here
        input_points = [
        [
            -69.89571589086567,
            -23.125348380249253,
            -74.689124410981
        ],
        [
            -68.59653901557081,
            -25.983537505898017,
            -74.689124410981
        ],
        [
            -68.85637439062975,
            -27.54254975625192,
            -80.189131370974
        ],
        [
            -69.11620976568875,
            -29.361397381664784,
            -80.189131370974
        ],
        [
            -69.11620976568875,
            -31.440080382136607,
            -80.189131370974
        ],
        [
            -68.85637439062975,
            -31.959751132254585,
            -80.189131370974
        ],
        [
            -68.59653901557081,
            -33.778598757667424,
            -80.189131370974
        ],
        [
            -68.33670364051183,
            -36.63678788331621,
            -80.189131370974
        ],
        [
            -68.33670364051183,
            -36.63678788331621,
            -85.689130684159
        ],
        [
            -68.07686826545283,
            -40.27448313414194,
            -85.689130684159
        ],
        [
            -66.25802064003999,
            -43.13267225979073,
            -85.689130684159
        ],
        [
            -65.738349889922,
            -46.25069676049848,
            -85.689130684159
        ],
        [
            -64.95884376474508,
            -49.36872126120626,
            -85.689130684159
        ],
        [
            -65.21867913980408,
            -53.526087262149936,
            -85.689130684159
        ],
        [
            -65.47851451486301,
            -56.12444101273974,
            -85.689130684159
        ],
        [
            -66.25802064003999,
            -58.98263013838853,
            -91.189129997343
        ],
        [
            -66.25802064003999,
            -60.801477763801394,
            -91.189129997343
        ],
        [
            -66.51785601509893,
            -63.139996139332204,
            -91.189129997343
        ],
        [
            -66.77769139015793,
            -66.25802064003996,
            -91.189129997343
        ],
        [
            -67.55719751533485,
            -68.33670364051181,
            -91.189129997343
        ],
        [
            -67.81703289039385,
            -70.67522201604262,
            -91.189129997343
        ],
        [
            -67.03752676521691,
            -74.31291726686835,
            -91.189129997343
        ],
        [
            -66.51785601509893,
            -77.43094176757613,
            -91.189129997343
        ],
        [
            -64.95884376474508,
            -79.50962476804796,
            -91.189129997343
        ],
        [
            -63.65966688945017,
            -81.06863701840186,
            -91.189129997343
        ],
        [
            -62.62032538921426,
            -83.14732001887369,
            -91.189129997343
        ],
        [
            -61.061313138860356,
            -84.44649689416859,
            -91.189129997343
        ],
        [
            -59.24246551344751,
            -86.00550914452246,
            -91.189129997343
        ],
        [
            -57.16378251297568,
            -88.60386289511227,
            -91.189129997343
        ],
        [
            -55.085099512503795,
            -90.42271052052513,
            -91.189129997343
        ],
        [
            -53.26625188709095,
            -91.72188739582002,
            -91.189129997343
        ],
        [
            -51.447404261678116,
            -92.50139352099698,
            -91.189129997343
        ],
        [
            -49.10888588614729,
            -93.28089964617392,
            -91.189129997343
        ],
        [
            -47.54987363579339,
            -95.61941802170473,
            -91.189129997343
        ],
        [
            -45.21135526026256,
            -97.69810102217659,
            -91.189129997343
        ],
        [
            -43.65234300990871,
            -99.51694864758946,
            -91.189129997343
        ],
        [
            -41.83349538449582,
            -101.85546702312027,
            -91.189129997343
        ],
        [
            -39.235141633906,
            -104.45382077371006,
            -91.189129997343
        ],
        [
            -37.41629400849316,
            -106.27266839912294,
            -91.189129997343
        ],
        [
            -34.558104882844404,
            -108.87102214971273,
            -91.189129997343
        ],
        [
            -31.18024500707766,
            -112.24888202547947,
            -91.189129997343
        ],
        [
            -27.802385131310917,
            -115.10707115112824,
            -91.189129997343
        ],
        [
            -25.204031380721098,
            -116.9259187765411,
            -91.189129997343
        ],
        [
            -21.566336129895365,
            -118.22509565183601,
            -91.189129997343
        ],
        [
            -21.566336129895365,
            -118.22509565183601,
            -85.689130684159
        ],
        [
            -19.227817754364537,
            -118.484931026895,
            -85.689130684159
        ],
        [
            -16.889299378833712,
            -118.484931026895,
            -85.689130684159
        ],
        [
            -16.889299378833712,
            -118.484931026895,
            -80.189131370974
        ],
        [
            -16.889299378833712,
            -118.484931026895,
            -74.689124410981
        ],
        [
            -16.889299378833712,
            -118.484931026895,
            -69.189125203162
        ],
        [
            -15.849957878597795,
            -115.36690652618722,
            -69.189125203162
        ],
        [
            -16.629464003774718,
            -111.46937590030254,
            -63.689125889978
        ],
        [
            -18.708147004246605,
            -107.57184527441783,
            -63.689125889978
        ],
        [
            -21.046665379777377,
            -103.67431464853313,
            -63.689125889978
        ],
        [
            -18.967982379305546,
            -98.99727789747148,
            -63.689125889978
        ],
        [
            -16.36962862871578,
            -95.87925339676373,
            -63.689125889978
        ],
        [
            -12.731933377890046,
            -95.09974727158679,
            -63.689125889978
        ],
        [
            -9.873744252241234,
            -94.06040577135086,
            -63.689125889978
        ],
        [
            -7.015555126592478,
            -92.76122889605595,
            -63.689125889978
        ],
        [
            -5.976213626356561,
            -94.06040577135086,
            -69.189125203162
        ],
        [
            -3.637695250825735,
            -91.72188739582002,
            -69.189125203162
        ],
        [
            -0.5196707501179854,
            -90.68254589558413,
            -69.189125203162
        ],
        [
            -0.5196707501179854,
            -90.68254589558413,
            -74.689124410981
        ],
        [
            2.5983537505898187,
            -89.90303977040716,
            -74.689124410981
        ],
        [
            6.495884376474546,
            -88.60386289511227,
            -74.689124410981
        ],
        [
            8.57456737694638,
            -88.60386289511227,
            -74.689124410981
        ],
        [
            11.692591877654074,
            -89.90303977040716,
            -74.689124410981
        ],
        [
            15.590122503538803,
            -91.72188739582002,
            -74.689124410981
        ],
        [
            17.408970128951697,
            -94.58007652146881,
            -74.689124410981
        ],
        [
            17.668805504010635,
            -97.17843027205862,
            -74.689124410981
        ],
        [
            17.668805504010635,
            -97.17843027205862,
            -69.189125203162
        ],
        [
            17.668805504010635,
            -97.4382656471176,
            -63.689125889978
        ],
        [
            17.668805504010635,
            -100.0366193977074,
            -63.689125889978
        ],
        [
            17.408970128951697,
            -102.37513777323822,
            -63.689125889978
        ],
        [
            16.889299378833712,
            -105.23332689888701,
            -63.689125889978
        ],
        [
            16.629464003774775,
            -105.75299764900495,
            -58.189126576794
        ]
    ]

        ppv = PointsToPlaneVectors(input_points,
                                   self.image_properties)

        _mpr_m = ppv.MPR_M
        _delta = ppv.delta

        n = _mpr_m.shape[0]
        m = _mpr_m.shape[1]

        self.vtk_data.SetDimensions(n, m, 1)
        self.vtk_data.SetOrigin(0, 0, 0)
        self.vtk_data.SetSpacing(_delta, _delta, _delta)

        vtk_type_by_numpy_type = {
            np.uint8: VTK_UNSIGNED_CHAR,
            np.uint16: VTK_UNSIGNED_SHORT,
            np.uint32: VTK_UNSIGNED_INT,
            np.uint64: VTK_UNSIGNED_LONG if VTK_SIZEOF_LONG == 64 else VTK_UNSIGNED_LONG_LONG,
            np.int8: VTK_CHAR,
            np.int16: VTK_SHORT,
            np.int32: VTK_INT,
            np.int64: VTK_LONG if VTK_SIZEOF_LONG == 64 else VTK_LONG_LONG,
            np.float32: VTK_FLOAT,
            np.float64: VTK_DOUBLE
        }

        vtk_datatype = vtk_type_by_numpy_type[_mpr_m.dtype.type]
        _mpr_m = np.transpose(_mpr_m)
        scalars = numpy_support.numpy_to_vtk(num_array=_mpr_m.ravel(), deep=True, array_type=vtk_datatype)

        self.vtk_data.GetPointData().SetScalars(scalars)
        self.vtk_data.Modified()

        self.parallel_scale = self.parallel_scale * _delta * (self.vtk_data.GetExtent()[1] - self.vtk_data.GetExtent()[0])
